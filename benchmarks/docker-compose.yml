services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: bench
    ports:
      - "5432:5432"

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  servera:
    build:
      context: .
      dockerfile: benchmarks/PostgreSignalR.Benchmarks.Server/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      Logging__LogLevel__Default: Warning
      BACKPLANE: ${BACKPLANE:-none}
      REDIS_CONNECTION: redis:6379
      POSTGRES_CONNECTION: Host=postgres;Database=bench;Username=postgres;Password=postgres
    depends_on:
      - postgres
      - redis
    ports:
      - "8081:8080"

  serverb:
    build:
      context: .
      dockerfile: benchmarks/PostgreSignalR.Benchmarks.Server/Dockerfile
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      Logging__LogLevel__Default: Warning
      BACKPLANE: ${BACKPLANE:-none}
      REDIS_CONNECTION: redis:6379
      POSTGRES_CONNECTION: Host=postgres;Database=bench;Username=postgres;Password=postgres
    depends_on:
      - postgres
      - redis
    ports:
      - "8082:8080"

  driver:
    build:
      context: .
      dockerfile: benchmarks/PostgreSignalR.Benchmarks/Dockerfile
    environment:
      SERVER_A: http://servera:8080
      SERVER_B: http://serverb:8080
      MODE: ${MODE:-single}
      CLIENTS: ${CLIENTS:-500}
      PUBLISH_COUNT: ${PUBLISH_COUNT:-20000}
      CONCURRENCY: ${CONCURRENCY:-128}
      PAYLOAD_BYTES: ${PAYLOAD_BYTES:-128}
      WARMUP_SECONDS: ${WARMUP_SECONDS:-10}
      MEASURE_SECONDS: ${MEASURE_SECONDS:-30}
    depends_on:
      - servera
      - serverb
